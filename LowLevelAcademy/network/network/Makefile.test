# Simple test makefile for network functionality

TARGET_SRV = bin/dbserver
TEST_PORT = 9090

.PHONY: test test-all test-socket test-shutdown

# Default test target
test: test-all

# Run all tests in sequence
test-all: test-socket test-shutdown
	@echo "\n==== All tests completed successfully ===="

# Test socket creation and binding
test-socket:
	@echo "\n==== Testing socket creation and binding ===="
	@if nc -z -w1 localhost $(TEST_PORT) 2>/dev/null; then \
	    echo "Error: Port $(TEST_PORT) is already in use"; \
	    exit 1; \
	fi
	@./$(TARGET_SRV) -f ./test.db -n -p $(TEST_PORT) & \
	SERVER_PID=$$!; \
	sleep 1; \
	if nc -z -w1 localhost $(TEST_PORT); then \
	    echo "✅ Socket test PASSED - Server is listening on port $(TEST_PORT)"; \
	    kill -TERM $$SERVER_PID; \
	    sleep 1; \
	else \
	    echo "❌ Socket test FAILED - Server not listening on port $(TEST_PORT)"; \
	    kill -TERM $$SERVER_PID 2>/dev/null; \
	    exit 1; \
	fi

# Test server shutdown
test-shutdown:
	@echo "\n==== Testing server shutdown ===="
	@./$(TARGET_SRV) -f ./test.db -n -p $(TEST_PORT) & \
	SERVER_PID=$$!; \
	sleep 1; \
	echo "Sending termination signal..."; \
	kill -TERM $$SERVER_PID; \
	sleep 2; \
	if ps -p $$SERVER_PID > /dev/null; then \
	    echo "❌ Shutdown test FAILED - Server didn't terminate properly"; \
	    kill -9 $$SERVER_PID; \
	    exit 1; \
	else \
	    echo "✅ Shutdown test PASSED - Server terminated gracefully"; \
	fi